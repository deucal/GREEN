<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
  <mapper namespace="Cmu">
   
   <!-- 글 작성 -->
   <insert id="insert_cmu" parameterType="CMU">
    INSERT INTO CMU
    ( CMU_CATE,CMU_TITLE,CMU_CONTENT,CMU_REG,USR_ID)
    VALUES
    ( #{CMU_CATE},#{CMU_TITLE},#{CMU_CONTENT},SYSDATE,#{USR_ID})
   </insert>
	
   <!-- 글 목록 리스트 (cntPerPage개) -->
   <select id="get_cmulist" parameterType="CMU" resultType="CMU">	
	SELECT *
	FROM cmu
	ORDER BY cmu_pk DESC
	OFFSET #{start} ROWS FETCH NEXT #{cntPerPage} ROWS ONLY
   </select>
   
   <!-- 글 갯수 세기 -->
   <select id="count_list" parameterType="CMU" resultType="Integer">
	SELECT COUNT(*)
	FROM CMU
	ORDER BY CMU_PK DESC 
   </select>
 
    <!-- 커뮤니티 상세보기 -->
	<select id="get_detailread" parameterType="CMU" resultType="CMU">
	SELECT *
	FROM cmu
	WHERE CMU_PK = #{CMU_PK}
	</select>
	
	<!-- 댓글 작성 -->
 	<insert id="imsert_coment" parameterType="CMU">
 	<selectKey resultType="Integer" keyProperty="CCM_PK" order="BEFORE">
        SELECT NVL(MAX(CCM_PK),0)+1 FROM CMU_COM
    </selectKey>       
	    INSERT INTO CMU_COM (CMU_PK, CCM_PK, USR_ID, CCM_DEL, CCM_CONTENT, CCM_REG, CCM_REF_LEVEL, CCM_REF, CCM_REF_LEVEL)
	    VALUES (#{CMU_PK}, #{CCM_PK}, #{USR_ID}, 0, #{CCM_CONTENT}, SYSDATE, #{CCM_REF_LEVEL},
		<choose>
        	<when test="reparent==null">#{CCM_PK}, 0</when>
            <otherwise>#{CCM_REF}, #{CCM_REF_LEVEL}</otherwise>
        </choose>
  		)	
	</insert>
	
	<update id="update_coment" parameterType="CMU">
    UPDATE CMU_COM
       SET CCM_CONTENT = #{CCM_CONTENT}
     WHERE CCM_PK = #{CCM_PK}
	</update>
	
	
	<select id="get_comentlist"  parameterType="CMU" resultType="CMU">
	SELECT *
	FROM CMU_COM
	WHERE CMU_PK = #{CMU_PK}
	</select>
	

  </mapper>